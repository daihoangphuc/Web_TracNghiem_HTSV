@model IEnumerable<Web_TracNghiem_HTSV.Models.Test>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<h1 class="text-4xl font-bold mb-8 text-center text-blue-600">Bài kiểm tra</h1>

@if (User.IsInRole("Administrators"))
{
    <div class="text-center mb-4">
        <a asp-action="Create" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Create New</a>
    </div>
}

<div class="overflow-x-auto">
    <table class="table-auto w-full border-collapse border border-gray-200">
        <thead>
            <tr class="bg-gray-100">
                <th class="px-4 py-2">Tên bài kiểm tra</th>
                <th class="px-4 py-2">Số lượt làm bài</th>
                @if (User.IsInRole("Administrators"))
                {
                    <th class="px-4 py-2">Chức năng</th>
                    <th class="px-4 py-2">Khóa/Mở khóa</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                var isAdmin = User.IsInRole("Administrators");
                var testId = item.TestId;
                var hasQuestions = ViewBag.ListQuestion.Contains(testId);
                var hasTakenTest = ViewBag.UserTestResulted.Contains(testId);

                // Kiểm tra và hiển thị từng hàng dữ liệu
                if (isAdmin || (hasQuestions && !item.IsLocked))
                {
                    <tr class="border-b border-gray-200">
                        <td class="px-4 py-2 whitespace-nowrap">
                            @Html.DisplayFor(modelItem => item.TestName)
                            @if (!hasQuestions)
                            {
                                <p class="text-warning">(Chưa có câu hỏi)</p>
                            }
                        </td>
                        <td class="px-4 py-2">
                            @if (isAdmin)
                            {
                                @if (hasQuestions)
                                {
                                    @if (ViewBag.countUserMakeTest != null)
                                    {
                                        var userCounts = ViewBag.countUserMakeTest as IEnumerable<dynamic>;
                                        var userCount = userCounts.FirstOrDefault(tr => tr.TestId == testId)?.UserCount ?? 0;
                                        <span>@userCount</span>
                                    }
                                    else
                                    {
                                        <span>0</span>
                                    }
                                }
                            }
                            else if (hasTakenTest)
                            {
                                <a asp-action="ResultOfTest" asp-route-id="@item.TestId" class="btn btn-primary bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Kết quả</a>
                            }
                            else
                            {
                                <a asp-action="TestDetails" asp-route-id="@item.TestId" class="btn btn-success bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Bắt đầu</a>
                            }
                        </td>
                        @if (isAdmin)
                        {
                            <td class="px-4 py-2">
                                <a asp-action="Edit" asp-route-id="@item.TestId" class="btn btn-info bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Edit</a>
                                <a asp-action="Delete" asp-route-id="@item.TestId" class="btn btn-danger bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Delete</a>
                            </td>
                            <td class="px-4 py-2">
                                <form asp-action="@((item.IsLocked ? "UnlockTest" : "LockTest"))" asp-route-id="@item.TestId" method="post">
                                    <button type="submit" class="btn @(item.IsLocked ? "btn-success bg-green-500 hover:bg-green-700" : "btn-danger bg-red-500 hover:bg-red-700") text-white font-bold py-2 px-4 rounded">
                                        @(item.IsLocked ? "Unlock" : "Lock")
                                    </button>
                                </form>
                            </td>
                        }
                    </tr>
                }
            }
        </tbody>
    </table>
</div>
