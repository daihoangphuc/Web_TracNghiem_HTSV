@model Web_TracNghiem_HTSV.Models.Test
@functions {
    public Web_TracNghiem_HTSV.Models.TestResult GetTestResultForQuestion(Web_TracNghiem_HTSV.Models.Question question)
    {
        var listTestResult = ViewBag.ListTestResult as List<Web_TracNghiem_HTSV.Models.TestResult>;
        return listTestResult.FirstOrDefault(tr => tr.QuestionId == question.QuestionId && tr.UserId == ViewBag.UserId);
    }
}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Results</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .correct-answer {
            background-color: #d4edda;
        }

        .wrong-answer {
            background-color: #f8d7da;
        }

        .user-selected {
            background-color: #c3e6cb;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-8">
        <h1 class="text-4xl font-bold mb-8 text-center text-blue-600">Kết quả</h1>
        @{
            int i = 1;
            var latestSubmittedAt = ViewBag.LatestSubmittedAt as DateTime?;
            var timeTaken = ViewBag.TimeTaken as TimeSpan?;
        }
        <div class="bg-white shadow-md rounded-lg p-6 mb-8">
            <p class="mb-4"><strong>Bài kiểm tra:</strong> @ViewBag.TestName</p>
            <p class="mb-4"><strong>Người làm bài:</strong> @User.Identity.Name.Substring(0, User.Identity.Name.IndexOf("@"))</p>
            <p class="mb-4"><strong>Tổng điểm:</strong> @((int)ViewBag.TotalScore / 10) điểm</p>
            <p class="mb-4">
                <strong>Thời gian làm bài:</strong>
                @if (timeTaken.HasValue)
                {
                    if (timeTaken.Value.TotalMinutes >= 60)
                    {
                        <span>@timeTaken.Value.Hours giờ</span>
                        if (timeTaken.Value.TotalSeconds >= 60)
                        {
                            <span> </span>
                        }
                    }
                    if (timeTaken.Value.TotalSeconds >= 60)
                    {
                        <span>@timeTaken.Value.Minutes phút</span>
                        if (timeTaken.Value.TotalSeconds > 60)
                        {
                            <span> </span>
                        }
                    }
                    <span>@timeTaken.Value.Seconds giây</span>
                }
            </p>
            @if (latestSubmittedAt.HasValue)
            {
                <p class="mb-4">
                    <strong>Nộp bài lúc:</strong>
                    @latestSubmittedAt.Value.ToString("HH:mm:ss '('dd/MM/yyyy'')")
                </p>
            }
            else
            {
                <p class="mb-4"><strong>Nộp bài lúc:</strong> Không có giá trị </p>
            }
        </div>

        @if (ViewBag.ListQuestion != null)
        {
            var questions = ViewBag.ListQuestion as List<Web_TracNghiem_HTSV.Models.Question>;
            if (questions != null)
            {
                foreach (var question in questions)
                {
                    var testResult = GetTestResultForQuestion(question);
                    @if (testResult != null)
                    {
                        <div class="bg-white shadow-md rounded-lg p-6 mb-8" id="question-@question.QuestionId">
                            <p class="mb-4"><strong>Câu hỏi @i:</strong> @question.QuestionContent</p>
                            <div class="grid grid-cols-1 gap-4">
                                <ul>
                                    @foreach (var answer in question.Answers.OrderBy(a => a.AnswerDescription))
                                    {
                                        var correctAnswer = question.CorrectAnswer;
                                        var selectedAnswer = testResult?.SelectedAnswer;

                                        <li>
                                            <label class="block bg-gray-200 p-3 m-3 rounded-lg transition duration-200 answer-label"
                                                   data-correct="@answer.AnswerDescription"
                                                   data-selected="@selectedAnswer"
                                                   data-is-correct="@answer.AnswerDescription"
                                                   data-is-selected="@selectedAnswer"
                                                   data-correct-answer="@correctAnswer"
                                                   data-selected-answer="@selectedAnswer"
                                                   data-question-id="@question.QuestionId">
                                                <input type="radio" name="selectedAnswer-@question.QuestionId" value="@answer.AnswerDescription" class="mr-2" @(selectedAnswer == answer.AnswerDescription ? "checked" : "") disabled>
                                                @answer.AnswerDescription
                                            </label>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p style="display: none">Bạn chưa làm bài kiểm tra này</p>
                    }
                    i++;
                }
            }
        }
        else
        {
            <p>Không có câu hỏi nào</p>
        }

        <div class="text-center mt-8">
            <a href="/Tests" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600 transition duration-200">
                Quay lại
            </a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const answerLabels = document.querySelectorAll('.answer-label');

            answerLabels.forEach(label => {
                const correctAnswer = label.dataset.correctAnswer;
                const selectedAnswer = label.dataset.selectedAnswer;
                const answerText = label.dataset.correct;

                if (correctAnswer === selectedAnswer && answerText === correctAnswer) {
                    label.classList.add('user-selected');
                } else if (answerText === correctAnswer) {
                    label.classList.add('correct-answer');
                } else if (answerText === selectedAnswer) {
                    label.classList.add('wrong-answer');
                }
            });
        });
    </script>
</body>

</html>




@* @model Web_TracNghiem_HTSV.Models.Test

@{
    ViewData["Title"] = "Kết quả bài kiểm tra";
}

<h1>@ViewBag.TestName</h1>

<div>
    <h2>Người dùng: @User.Identity.Name</h2>
    <h3>Tổng điểm: @ViewBag.TotalScore</h3>

    <table class="table">
        <thead>
            <tr>
                <th>Câu hỏi</th>
                <th>Các đáp án</th>
                <th>Đáp án đúng</th>
                <th>Đáp án đã chọn</th>
                <th>Kết quả</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var question in ViewBag.ListQuestion)
            {
                <tr>
                    <td>@question.QuestionContent</td>
                    <td>
                        <ul>
                            @foreach (var answer in question.Answers)
                            {
                                <li>@answer.AnswerDescription</li>
                            }
                        </ul>
                    </td>
                    <td>@question.CorrectAnswer</td>

                    @if (ViewBag.ListTestResult != null && ViewBag.ListTestResult.Count > 0)
                    {
                        var testResult = ViewBag.ListTestResult[ViewBag.ListQuestion.IndexOf(question)];
                        <td class="bg-warning">@testResult.SelectedAnswer</td>
                        <td class="bg-warning">@(testResult.IsCorrect ? "Đúng" : "Sai")</td>
                    }
                    else
                    {
                        <td colspan="2">Không có kết quả cho câu hỏi này</td>
                    }
                </tr>
            }


        </tbody>
    </table>
</div>

<div>
    <a asp-action="Index">Trở lại danh sách</a>
</div>
 *@